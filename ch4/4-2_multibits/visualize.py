import matplotlib.pyplot as plt
import numpy as np

# n0b1: b1 means 1 bit, or d=1
#       n0 means the total number CPA runs using d-bit selection function for recovering k0
# k0 means the first half of the key
# k1 means the second half of the key

# t0,t1,t2,t3,t4 mean the 5 datasets

# Each number in the arrays below represents the number of times that the key bits are successfully recovered.
# These numbers correspond to an increasing number of traces: [250, 500, 750, 1000, ..., 10000].
# For example, n0b1 = 23 means the total number CPA runs is 23. We translate the results into the following table:
#   NbOfTraces      [ 250,  500,  750, ..., 10000]
#   Success/Total   [4/23, 7/23, 6/23, ..., 23/23]

n0b1 = 23
n1b1 = 24
t0_k0b1 = [4, 7, 6, 6, 6, 6, 7, 8, 7, 8, 10, 12, 13, 14, 13, 13, 16, 17, 18, 18, 19, 18, 20, 21, 21, 21, 21, 21, 20, 20, 21, 21, 23, 23, 23, 23, 23, 23, 23, 23]
t0_k1b1 = [2, 8, 10, 15, 20, 19, 19, 21, 22, 21, 21, 22, 23, 23, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24]
t1_k0b1 = [2, 3, 5, 7, 8, 11, 10, 9, 9, 12, 17, 15, 14, 16, 14, 17, 13, 18, 18, 18, 21, 20, 20, 21, 21, 20, 22, 22, 20, 21, 22, 22, 22, 22, 22, 22, 22, 22, 22, 22]
t1_k1b1 = [3, 6, 9, 9, 15, 16, 19, 20, 21, 22, 22, 23, 22, 23, 23, 24, 24, 23, 23, 23, 23, 23, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24]
t2_k0b1 = [2, 2, 6, 6, 6, 6, 6, 9, 9, 15, 13, 14, 14, 15, 15, 16, 18, 18, 18, 18, 18, 18, 18, 19, 19, 19, 19, 20, 20, 22, 22, 22, 22, 22, 22, 22, 22, 22, 22, 22]
t2_k1b1 = [5, 6, 7, 8, 11, 15, 15, 22, 21, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24]
t3_k0b1 = [2, 4, 3, 5, 6, 7, 4, 7, 10, 13, 11, 11, 10, 11, 12, 13, 14, 14, 14, 14, 13, 12, 14, 16, 15, 15, 16, 18, 17, 18, 19, 19, 19, 21, 22, 23, 22, 23, 23, 23]
t3_k1b1 = [3, 4, 6, 7, 10, 12, 17, 18, 18, 21, 21, 22, 23, 21, 23, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24]
t4_k0b1 = [4, 2, 4, 5, 4, 5, 4, 7, 6, 7, 7, 8, 9, 10, 12, 14, 17, 16, 17, 17, 17, 17, 17, 17, 18, 19, 20, 20, 20, 20, 20, 20, 20, 20, 20, 21, 22, 22, 22, 22]
t4_k1b1 = [4, 6, 15, 16, 17, 21, 20, 21, 22, 22, 22, 22, 21, 24, 24, 24, 24, 23, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24]
cn_k0b1 = np.array([t0_k0b1, t1_k0b1, t2_k0b1, t3_k0b1, t4_k0b1]) 
cn_k1b1 = np.array([t0_k1b1, t1_k1b1, t2_k1b1, t3_k1b1, t4_k1b1])

n0b2 = 14
n1b2 = 14
t0_k0b2 = [0, 0, 1, 0, 1, 0, 1, 2, 4, 4, 6, 7, 8, 9, 13, 12, 13, 12, 12, 12, 13, 13, 13, 13, 13, 13, 13, 14, 14, 13, 13, 14, 14, 14, 14, 14, 14, 14, 14, 14]
t0_k1b2 = [2, 3, 5, 10, 11, 12, 13, 13, 13, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14]
t1_k0b2 = [1, 0, 0, 1, 3, 3, 5, 3, 6, 8, 9, 10, 9, 11, 11, 11, 10, 9, 10, 11, 11, 12, 12, 12, 12, 13, 12, 12, 12, 13, 12, 13, 13, 14, 14, 13, 14, 14, 14, 14]
t1_k1b2 = [1, 2, 4, 4, 10, 12, 12, 13, 13, 13, 14, 14, 14, 14, 14, 13, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14]
t2_k0b2 = [0, 0, 0, 0, 3, 3, 4, 5, 7, 6, 8, 9, 8, 11, 12, 12, 13, 13, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14]
t2_k1b2 = [0, 2, 4, 7, 12, 12, 11, 13, 11, 13, 13, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14]
t3_k0b2 = [0, 0, 1, 4, 2, 1, 4, 3, 7, 6, 7, 6, 8, 10, 9, 10, 9, 11, 12, 12, 12, 12, 13, 13, 13, 13, 13, 13, 13, 13, 13, 13, 13, 13, 13, 13, 13, 13, 13, 13]
t3_k1b2 = [0, 0, 1, 5, 7, 11, 12, 12, 12, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14]
t4_k0b2 = [0, 0, 1, 0, 1, 2, 3, 5, 6, 5, 6, 6, 7, 6, 8, 7, 9, 10, 11, 11, 11, 11, 12, 12, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14]
t4_k1b2 = [2, 4, 4, 7, 11, 12, 13, 12, 14, 14, 14, 14, 14, 14, 14, 14, 14, 13, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14]
cn_k0b2 = np.array([t0_k0b2, t1_k0b2, t2_k0b2, t3_k0b2, t4_k0b2]) 
cn_k1b2 = np.array([t0_k1b2, t1_k1b2, t2_k1b2, t3_k1b2, t4_k1b2])

n0b3 = 10
n1b3 = 9
t0_k0b3 = [0, 0, 0, 1, 1, 1, 1, 1, 3, 3, 2, 4, 4, 5, 6, 7, 7, 7, 7, 8, 7, 7, 7, 7, 7, 6, 8, 7, 8, 9, 9, 9, 9, 9, 9, 9, 9, 10, 10, 10]
t0_k1b3 = [0, 0, 2, 6, 6, 7, 9, 8, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9]
t1_k0b3 = [0, 0, 0, 0, 2, 3, 3, 2, 3, 5, 5, 6, 5, 6, 6, 9, 8, 9, 9, 8, 9, 9, 10, 9, 9, 9, 10, 10, 9, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10]
t1_k1b3 = [0, 0, 3, 2, 6, 6, 7, 8, 9, 9, 9, 9, 9, 9, 9, 8, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9]
t2_k0b3 = [1, 1, 0, 1, 0, 0, 1, 3, 4, 6, 6, 6, 7, 7, 8, 9, 10, 10, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 10, 9, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10]
t2_k1b3 = [0, 2, 3, 5, 8, 8, 6, 8, 8, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9]
t3_k0b3 = [0, 0, 0, 1, 2, 1, 1, 3, 7, 7, 9, 9, 8, 9, 8, 9, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10]
t3_k1b3 = [0, 0, 3, 7, 8, 7, 8, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9]
t4_k0b3 = [0, 0, 1, 0, 0, 0, 0, 1, 2, 2, 2, 4, 5, 5, 6, 6, 6, 6, 6, 6, 6, 6, 7, 7, 8, 8, 9, 8, 9, 9, 9, 8, 9, 10, 10, 10, 10, 10, 10, 10]
t4_k1b3 = [0, 0, 2, 3, 3, 8, 8, 7, 8, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9]
cn_k0b3 = np.array([t0_k0b3, t1_k0b3, t2_k0b3, t3_k0b3, t4_k0b3]) 
cn_k1b3 = np.array([t0_k1b3, t1_k1b3, t2_k1b3, t3_k1b3, t4_k1b3])

n0b4 = 8
n1b4 = 7
t0_k0b4 = [0, 0, 0, 0, 1, 1, 1, 1, 3, 2, 4, 2, 5, 5, 5, 5, 6, 6, 7, 7, 6, 6, 6, 7, 6, 5, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 8, 8, 8]
t0_k1b4 = [0, 0, 2, 5, 5, 6, 7, 6, 5, 6, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7]
t1_k0b4 = [0, 0, 0, 1, 1, 1, 1, 2, 4, 5, 5, 6, 6, 5, 6, 7, 7, 7, 7, 7, 6, 8, 8, 8, 7, 7, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8]
t1_k1b4 = [0, 0, 1, 2, 6, 5, 5, 6, 5, 6, 7, 6, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7]
t2_k0b4 = [0, 0, 0, 0, 1, 1, 0, 1, 2, 3, 3, 4, 4, 4, 5, 4, 5, 5, 6, 7, 6, 7, 7, 7, 7, 7, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8]
t2_k1b4 = [0, 2, 3, 6, 5, 6, 6, 6, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7]
t3_k0b4 = [0, 0, 0, 0, 0, 0, 0, 2, 4, 4, 6, 6, 6, 7, 7, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8]
t3_k1b4 = [0, 0, 0, 2, 4, 5, 5, 5, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7]
t4_k0b4 = [0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 2, 3, 3, 4, 4, 3, 7, 6, 6, 6, 6, 6, 6, 7, 8, 7, 8, 7, 8, 8, 8, 8, 7, 8, 8, 8, 8, 8, 8, 8]
t4_k1b4 = [0, 0, 3, 3, 5, 5, 4, 5, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7]
cn_k0b4 = np.array([t0_k0b4, t1_k0b4, t2_k0b4, t3_k0b4, t4_k0b4]) 
cn_k1b4 = np.array([t0_k1b4, t1_k1b4, t2_k1b4, t3_k1b4, t4_k1b4])

nn = 10000
ns = 250
nbtrace_range = list(range(ns, nn+1, ns))
plt.figure(figsize=(6, 4))

sr_k0b1 = (np.sum(cn_k0b1, axis=0)/(n0b1*5))**n0b1
sr_k1b1 = (np.sum(cn_k1b1, axis=0)/(n1b1*5))**n1b1
sr_b1 = sr_k0b1*sr_k1b1

sr_k0b2 = (np.sum(cn_k0b2, axis=0)/(n0b2*5))**n0b2
sr_k1b2 = (np.sum(cn_k1b2, axis=0)/(n1b2*5))**n1b2
sr_b2 = sr_k0b2*sr_k1b2

sr_k0b3 = (np.sum(cn_k0b3, axis=0)/(n0b3*5))**n0b3
sr_k1b3 = (np.sum(cn_k1b3, axis=0)/(n1b3*5))**n1b3
sr_b3 = sr_k0b3*sr_k1b3

sr_k0b4 = (np.sum(cn_k0b4, axis=0)/(n0b4*5))**n0b4
sr_k1b4 = (np.sum(cn_k1b4, axis=0)/(n1b4*5))**n1b4
sr_b4 = sr_k0b4*sr_k1b4

plt.plot(nbtrace_range, sr_b1, label=r"d=1")
plt.plot(nbtrace_range, sr_b2-0.007, label=r"d=2")
plt.plot(nbtrace_range, sr_b3, label=r"d=3")
plt.plot(nbtrace_range, sr_b4+0.007, label=r"d=4")

plt.xlabel("Number of traces")
plt.ylabel("Success rate")
plt.legend()
plt.tight_layout()

plt.savefig("outputs/multibitsSR.png")